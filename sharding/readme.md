# Масштабируемая подсистема диалогов 
Для имитации диалоговой системы предстваим что запись сообщения в БД имеет простую структуру вида (id varchar(36), id_user_1 int, id_user_2 int, message text).<br>
В диалоговой системе есть пользователь который много пишет/ему много пишут(т.н. "Леди Гага"").<br>
Для этого выделим одну ноду инстанса MySQL для хранения сообщений одного пользователя. <br>
Используем ProxySQL и 2 ноды MySQL.<br>
В конфиг proxysql добавляются 2 хост группы и Для разделения данных используем key-based sharding. <br>
Создадим 4 правила:
1. "INSERT INTO messages \(id, id_user_1, id_user_2, message\) VALUES \(uuid.., 200"
2. "id_user_1 = 200"
3. "INSERT INTO messages \(id, id_user_1, id_user_2, message\) VALUES \(uuid.., \d*, 200"
4. "id_user_2 = 200"

Запросы пропадающие под эти паттерны уходят на вторую ноду. (Полный конфиг лежит в sharding/proxysql/proxysql/proxysql.cnf.) <br>
Для проверки тестовым скриптом сгенерим 300 INSERT с помощью фэйкера (sharding/data_gen/main.py) - 200 из которых принадлежат "Леди Гаге" подключившись на ProxySQL. <br>
В 1ую ноду ушло записей, на вторую 200 - получили ожидаемое поведение.<br>

Проблемы данного решения:

* если использовать интовые id то генерация id на клиенте и запоминание его во внешнем хранилище (чтобы не расходились id в шардах, в данном решении использован uuid)
* для чтения данных через ProxySQL со второго шарда надо в явном виде указывать чтобы правила сработали (select * from messages уйдет только на 1 шард)
* при коммите 2 инсертов данные могут уйти не туда - (допустим если 2 инсерта сделать где первый попадает под правила то они оба уходят на вторую ноду) 
* проблема с решардингом - данное решение не имеет своих механизмов решардинга, придётся в ручном режиме переливать данные из старых шардов в новые

