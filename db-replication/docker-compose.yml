version: '3.7'

services:
  mysql:
    image: 'percona:8.0'
    container_name: db-master
    volumes:
      - ./build_env/mysql/master.cnf:/etc/my.cnf.d/repl.cnf
      - ./build_env/mysql/master.sql:/docker-entrypoint-initdb.d/start.sql
    environment:
      MYSQL_DATABASE: 'db'
      # So you don't have to use root, but you can if you like
      MYSQL_USER: 'user'
      # You can use whatever password you like
      MYSQL_PASSWORD: 'password'
      MYSQL_ROOT_PASSWORD: "secret"

  mysqlread1:
    image: 'percona:8.0'
    container_name: db-slave1
    volumes:
      - ./build_env/mysql/slave1.cnf:/etc/my.cnf.d/repl.cnf
      - ./build_env/mysql/slave.sql:/docker-entrypoint-initdb.d/start.sql
    depends_on:
      - mysql
    environment:
      MYSQL_DATABASE: 'db'
      # So you don't have to use root, but you can if you like
      MYSQL_USER: 'user'
      # You can use whatever password you like
      MYSQL_PASSWORD: 'password'
      MYSQL_ROOT_PASSWORD: "secret"

  mysqlread2:
    image: 'percona:8.0'
    container_name: db-slave2
    volumes:
      - ./build_env/mysql/slave2.cnf:/etc/my.cnf.d/repl.cnf
      - ./build_env/mysql/slave.sql:/docker-entrypoint-initdb.d/start.sql
    depends_on:
      - mysql
    environment:
      MYSQL_DATABASE: 'db'
      # So you don't have to use root, but you can if you like
      MYSQL_USER: 'user'
      # You can use whatever password you like
      MYSQL_PASSWORD: 'password'
      MYSQL_ROOT_PASSWORD: "secret"

  liquibase:
    build:
      context: ../db-migrations/
    command: update
    restart: on-failure
    container_name: liquibase
    environment:
      - LIQUIBASE_CHANGELOG=changelog.xml
      - LIQUIBASE_URL=jdbc:mysql://mysql:3306
      - LIQUIBASE_USERNAME=root
      - LIQUIBASE_PASSWORD=secret
    depends_on:
      - mysql
